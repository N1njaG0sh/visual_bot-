import telebot
import random
import os
import requests
from datetime import datetime
from imageai.Detection import ObjectDetection
from PIL import Image, ImageOps  # Installing pillow instead of PIL
import PIL

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ –æ–±—ä–µ–∫—Ç–æ–≤
detector = ObjectDetection()
model_path = "yolov3.pt"  # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!
detector.setModelTypeAsYOLOv3()
detector.setModelPath(model_path)
detector.loadModel()

bot = telebot.TeleBot("****************")


@bot.message_handler(commands=['start'])
def send_welcome(message):
    bot.reply_to(message, "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π Telegram –±–æ—ÇüòÅ. –ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å! üôå")

@bot.message_handler(content_types=['photo'])
def picture(message):
  try:
      # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–æ—Ç–æ (—Å–∞–º–æ–µ –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—ã—á–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤ —Å–ø–∏—Å–∫–µ)
      file_id = message.photo[-1].file_id
      file_info = bot.get_file(file_id)
      downloaded_file = bot.download_file(file_info.file_path)

      # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
      timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
      filename = f"user_images/photo_{message.from_user.id}_{timestamp}.jpg"

      # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
      with open(filename, 'wb') as new_file:
          new_file.write(downloaded_file)

      bot.reply_to(message, f"‚úÖ –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ, –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é")
      output_filename = f"output_images/output_{message.from_user.id}_{timestamp}.jpg"

      # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      detections = detector.detectObjectsFromImage(
          input_image=filename,
          output_image_path=output_filename,
          minimum_percentage_probability=30
        )




      # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ —Ñ–æ—Ç–æ - –û–¢–ö–†–´–í–ê–ï–ú –í –†–ï–ñ–ò–ú–ï –ß–¢–ï–ù–ò–Ø 'rb'
      with open(output_filename, 'rb') as photo_file:
          bot.send_photo(message.chat.id, photo_file, caption="‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
      information = []
      t = ''
      for click in detections:
        t +=(click['name'] + ' ' + str(click['percentage_probability']) + '\n')
      bot.reply_to(message, t)







  except Exception as e:
          bot.reply_to(message, f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: {str(e)}")

bot.polling()
